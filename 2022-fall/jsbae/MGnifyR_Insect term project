install.packages("devtools")  # Devtool 다운로드
source('http://bioconductor.org/biocLite.R') # Bioconductor에서 가져오기
if (!require("BiocManager", quietly = TRUE)) # Biomanager 다운로드
  install.packages("BiocManager")
BiocManager::install(version = "3.16")

biocLite("phyloseq") # bioclite로 phyloseq 다운로드
source("http://bioconductor.org/biocLite.R")
source("https://raw.githubusercontent.com/joey711/phyloseq/master/inst/scripts/installer.R",
       local = TRUE)

install_github("beadyallen/MGnifyR") #제작자 Github 경로로 MgnifyR 다운로드
library("devtools")
install_github("beadyallen/MGnifyR")
library(MGnifyR) # MgnifyR library 실행

mgnify_client() # Mgnify 클라이언트 실행
mgnify_client(username = "Webin-63754", password = "Ranger0908*", usecache = T) # Mgnify 웹페이지 로그인
mg <- mgnify_client(usecache = T, cache_dir = "~/Desktop/MGnifyR_cache") # 캐시 사용 및 디렉토리 설정


mgnify_query(mg, qtype = "samples", maxhits=10, usecache = T) # 쿼리함수로 데이터 불러오기
J <- mgnify_query(mg, qtype = "samples", biome_name = "insecta", maxhits=200, usecache = T) # samples / insecta / maxhit 설정(0보다 작을시 불러오는 데이터 제한 없음)
colnames(J) # 불러온 데이터 나열
insect_samples = mgnify_query(mg, qtype="samples", biome_name = "insecta", experiment_type = "amplicon",
                              maxhits=200, usecache = T)

samp_acc <- insect_samples$accession # sample로 설정한 qtype을 변환
samp_acc
(an_acc <- mgnify_analyses_from_samples(mg, samp_acc)) # sample anaylses 데이터를 an_acc로 설정
metadata <- mgnify_get_analyses_metadata(mg, an_acc, usecache=T) # 설정한 파라미터?에 대한 metadata 가져오기
head(metadata) # 앞부분 보여주는거
colnames(metadata) # metadata 내용 나열
metadata$'analysis_analysis-status' # metadata 내용 선택적으로 보여주기
table(metadata$'analysis_instrument-model') # table 형태
metadata[metadata$'analysis_instrument-model' == "Illumina HiSeq 2500",] # 예시

amplicon_accessions <- metadata$analysis_accession[metadata$'analysis_experiment-type'=="amplicon"]
ps <- mgnify_get_analyses_phyloseq(mg, amplicon_accessions)
ps@otu_table # OTU table view (샘플 개수, taxa 개수)
ps@tax_table # OTU를 기준으로 한 taxa 테이블 view, kindom ~ genus까지 나열

tax_table(ps)
otu_table(ps)
sample_data(ps)
tax_table(ps)

library(phyloseq) # Barplot 그리는 단계
psglom <- tax_glom(ps, "Genus")
normed_ps <- transform_sample_counts(psglom, function(x) x/sum(x))

plot_bar(normed_ps, fill="Phylum") # Phylum level에서 sample들의 microbiome 구성 비교
plot_bar(normed_ps, fill="Class")
plot_bar(normed_ps, fill="Order")
plot_bar(normed_ps, fill="Genus") 

ord <- ordinate(ps, "NMDS", "bray") # NMDS (Non-metric multidimensional scaling / Bray-Curtis dissimilarity method 사용
plot_ordination(ps, ord) + geom_point(aes(color=as.numeric(sample_latitude)), size=8) + theme_bw() # numeric() 함수 안에 들어가는 metadata 값 바꿔줄 수 있음
plot_ordination(ps, ord) + geom_point(aes(color=as.numeric(sample_longitude)), size=8) + theme_bw()
plot_ordination(ps, ord) + geom_point(aes(color=as.numeric(analysis_Submitted_nucleotide_sequences)), size=8) + theme_bw() # analysis_Submitted_nucleotide_sequences object가 없다고 나옴
plot_tree(ps, size="abundance", sizebase=2, label.tips="taxa_names") # object에 phylogenetic tree 없다고 나옴

mgnify_get_analyses_results(mg, acc_list, retrievelist = c("go-slim", "taxonomy-ssu"))
acc_list <- metadata$analysis_accession[metadata$'analysis_experiment-type' == "amplicon"]
                                       
func_results <- mgnify_get_analyses_results(mg, acc_list, retrievelist = c("go-slim", "taxonomy-ssu" ))
names(func_results)
func_results$'go_slim'

library("phyloseq"); packageVersion("phyloseq")
library("ggplot2"); packageVersion("ggplot2")
theme_set(theme_bw())
phyloseqimport =  system.file("MGnifyR_cache", "biom_files", package = "phyloseq")
import_biom(biom_files, treefilename, refseqfilename, parseFunction=parse_taxonomy_greengenes)
biomformat::read_biom(":")

import_biom(BIOMfilename = "SRS1321708_format_json") # 이건 어떻게 하는지 확인해 
data(mg) # 데이터값 바꿔주기
gp.ch = subset_taxa(GlobalPatterns, Phylum == "Chlamydiae") # 어느 taxa level의 수준에서 bar plot 만들지?


prune_samples(samples = colnames(otu_table(ps))[1:50], ps)
ps_sample50 <-prune_samples(samples = colnames(otu_table(ps))[1:50], ps)

top20 <- names(sort(taxa_sums(ps_sample50), decreasing=TRUE))[1:50]
ps.top20 <- transform_sample_counts(ps_sample50, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                             axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                       axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                        axis.ticks.x=element_blank())
plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                       axis.ticks.x=element_blank())
plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())
 
prune_samples(samples = colnames(otu_table(ps))[51:100], ps)
ps_sample100 <-prune_samples(samples = colnames(otu_table(ps))[51:100], ps)

top20 <- names(sort(taxa_sums(ps_sample50), decreasing=TRUE))[51:100]
ps.top20 <- transform_sample_counts(ps_sample100, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

prune_samples(samples = colnames(otu_table(ps))[101:150], ps)
ps_sample150 <-prune_samples(samples = colnames(otu_table(ps))[101:150], ps)

top20 <- names(sort(taxa_sums(ps_sample150), decreasing=TRUE))[101:150]
ps.top20 <- transform_sample_counts(ps_sample150, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

prune_samples(samples = colnames(otu_table(ps))[151:200], ps)
ps_sample200 <-prune_samples(samples = colnames(otu_table(ps))[151:200], ps)

top20 <- names(sort(taxa_sums(ps_sample200), decreasing=TRUE))[151:200]
ps.top20 <- transform_sample_counts(ps_sample200, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

prune_samples(samples = colnames(otu_table(ps))[201:250], ps)
ps_sample250 <-prune_samples(samples = colnames(otu_table(ps))[201:250], ps)

top20 <- names(sort(taxa_sums(ps_sample250), decreasing=TRUE))[201:250]
ps.top20 <- transform_sample_counts(ps_sample250, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

prune_samples(samples = colnames(otu_table(ps))[251:300], ps)
ps_sample300 <-prune_samples(samples = colnames(otu_table(ps))[251:300], ps)

top20 <- names(sort(taxa_sums(ps_sample300), decreasing=TRUE))[251:300]
ps.top20 <- transform_sample_counts(ps_sample300, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

prune_samples(samples = colnames(otu_table(ps))[1:350], ps)
ps_sample350 <-prune_samples(samples = colnames(otu_table(ps))[1:350], ps)

top20 <- names(sort(taxa_sums(ps_sample350), decreasing=TRUE))[1:350]
ps.top20 <- transform_sample_counts(ps_sample350, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)


plot_bar(ps.top20, fill="Phylum") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Class") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Family") + theme(axis.text.x=element_blank(),
                                          axis.ticks.x=element_blank())


plot_bar(ps.top20, fill="Order") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())

plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank(),
                                         axis.ticks.x=element_blank())




metadata$`sample_host-tax-id`
plot_bar(ps.top20, fill="Genus") + theme(axis.text.x=element_blank()) + facet_wrap(~sample_host.taxid, scales="free_x")
